# Mapoteca Digital - Automa√ß√£o de Publica√ß√£o de Mapas

## üéØ Contexto
Sistema low-code em ArcGIS Experience Builder para automatizar cadastro de mapas.
Substitui processo manual de 30min por processo automatizado de 5min (83% redu√ß√£o).

## üìö Leia Primeiro (OBRIGAT√ìRIO)
1. docs/BRIEFING.md - Problema e objetivos
2. docs/DATABASE.md - Modelo completo (18 tabelas)
3. docs/DIAGRAMA_ER.md - Relacionamentos
4. docs/DFD.md - Fluxo de dados
5. docs/PRD.md - Requisitos detalhados

## üèóÔ∏è Stack Tecnol√≥gica
- **Frontend**: ArcGIS Experience Builder (widgets nativos)
- **Backend**: PostgreSQL 13+ com PostGIS e SDE
- **Storage**: PDFs em PostgreSQL via ESRI Attachments
- **Deploy**: ArcGIS Enterprise

## üîë Regras de Neg√≥cio Cr√≠ticas

### 1. Valida√ß√µes em Cascata
```
Classe Mapa ‚Üí Tipo Mapa (via t_classe_mapa_tipo_mapa)
Tipo Regionaliza√ß√£o ‚Üí Regi√£o (via t_regionalizacao_regiao)
Tipo Tema ‚Üí Tema (via t_tipo_tema_tema)
```

### 2. GlobalID (UUID)
- Gerado automaticamente pelo PostgreSQL
- Campo √∫nico em t_publicacao e t_publicacao_municipios
- Chave de relacionamento com tabelas de attachments

### 3. Gest√£o de Attachments
- Estrutura SDE nativa do ArcGIS
- Relacionamento via globalid
- Campos: rel_globalid, att_name, content_type, data, data_size
- Limite: 50MB por PDF
- Tipo: apenas application/pdf

### 4. Publica√ß√µes Separadas
- **Estaduais/Regionais**: t_publicacao + t_publicacao__attach
- **Municipais**: t_publicacao_municipios + t_publicacao_municipios_attach

## ‚ö° Requisitos de Performance
- Carregamento formul√°rio: < 3 segundos
- Salvamento registro: < 1 segundo
- Upload PDF (50MB): < 30 segundos
- Listagem paginada: < 2 segundos
- Uptime: 99.5%

## üìä Estrutura do Banco (18 tabelas)
```
CAMADA 1 - Dom√≠nio (9 tabelas):
  t_classe_mapa (2), t_tipo_mapa (3), t_anos (33),
  t_escala (9), t_cor (2), t_tipo_tema (6),
  t_tipo_regionalizacao (11), t_regiao (106), t_tema (55)

CAMADA 2 - Relacionamentos N:N (3 tabelas):
  t_classe_mapa_tipo_mapa (6)
  t_regionalizacao_regiao (229)
  t_tipo_tema_tema (55)

CAMADA 3 - Munic√≠pios (1 tabela):
  t_municipios (417)

CAMADA 4 - Publica√ß√µes/Fato (2 tabelas):
  t_publicacao (estaduais/regionais)
  t_publicacao_municipios (municipais)

CAMADA 5 - Attachments (2 tabelas):
  t_publicacao__attach
  t_publicacao_municipios_attach
```

## üé® Padr√µes de C√≥digo

### SQL
- SEMPRE usar prepared statements
- SEMPRE validar FKs antes de INSERT
- SEMPRE usar transa√ß√µes para opera√ß√µes relacionadas
- SEMPRE consultar tabelas N:N para valida√ß√µes em cascata

### Experience Builder
- Preferir widgets nativos (Form, List, Map)
- Minimizar c√≥digo customizado (princ√≠pio low-code)
- Seguir conven√ß√µes ESRI
- Implementar lazy loading para dropdowns grandes

### Valida√ß√µes
```sql
-- Exemplo: Validar classe + tipo
SELECT COUNT(*) 
FROM t_classe_mapa_tipo_mapa 
WHERE id_classe_mapa = :classe 
  AND id_tipo_mapa = :tipo;
-- Deve retornar 1 para ser v√°lido
```

## üö´ N√£o Implementar
- ‚ùå Sistema de autentica√ß√£o customizado (usar ArcGIS Enterprise)
- ‚ùå API REST customizada (usar Feature Services)
- ‚ùå Storage em filesystem ou URLs externas (usar PostgreSQL SDE)
- ‚ùå Modifica√ß√µes na estrutura de tabelas existentes
- ‚ùå Remo√ß√£o de √≠ndices do banco

## ‚úÖ Manter Compatibilidade
Garantir funcionamento das 4 aplica√ß√µes existentes:
1. Mapas Estaduais
2. Mapas Regionais
3. Mapas Municipais
4. Cartogramas Estaduais

## üß™ Checklist de Testes

### Funcional
- [ ] Criar publica√ß√£o estadual com PDF
- [ ] Criar publica√ß√£o municipal com PDF
- [ ] Editar publica√ß√£o existente
- [ ] Substituir PDF de publica√ß√£o
- [ ] Excluir publica√ß√£o (com confirma√ß√£o)
- [ ] Valida√ß√µes em cascata funcionando corretamente
- [ ] Filtros de consulta operacionais

### Performance
- [ ] Carregar formul√°rio em < 3s
- [ ] Salvar registro em < 1s
- [ ] Upload 50MB em < 30s
- [ ] Listar 100 publica√ß√µes em < 2s

### Compatibilidade
- [ ] App Mapas Estaduais funcionando
- [ ] App Mapas Regionais funcionando
- [ ] App Mapas Municipais funcionando
- [ ] App Cartogramas Estaduais funcionando

## üìã Ordem de Implementa√ß√£o

### Fase 1: Foundation (Semana 1-2)
1. Revisar e validar schema PostgreSQL
2. Configurar Feature Services no ArcGIS Server
3. Configurar estrutura SDE Attachments
4. Migrar dados CSV para PostgreSQL

### Fase 2: Core Form (Semana 3-4)
1. Criar formul√°rio principal no Experience Builder
2. Implementar dropdowns com sele√ß√£o em cascata
3. Implementar valida√ß√µes de neg√≥cio
4. Testes funcionais do formul√°rio

### Fase 3: Attachments (Semana 5-6)
1. Implementar upload de PDFs
2. Implementar visualiza√ß√£o inline
3. Implementar substitui√ß√£o/exclus√£o
4. Testes de anexos

### Fase 4: Integration (Semana 7-8)
1. Testes de compatibilidade com apps existentes
2. Ajustes necess√°rios
3. Testes de integra√ß√£o
4. Documenta√ß√£o t√©cnica

### Fase 5: Optimization (Semana 9-10)
1. Otimiza√ß√µes de performance
2. Ajustes de UX baseados em feedback
3. Testes de carga
4. Deploy em produ√ß√£o

## üîç SQL √ötil

### Obter Combina√ß√µes V√°lidas
```sql
-- Classes e tipos permitidos
SELECT cm.nome_classe_mapa, tm.nome_tipo_mapa
FROM t_classe_mapa_tipo_mapa cmtm
JOIN t_classe_mapa cm ON cmtm.id_classe_mapa = cm.id_classe_mapa
JOIN t_tipo_mapa tm ON cmtm.id_tipo_mapa = tm.id_tipo_mapa;

-- Regi√µes por tipo de regionaliza√ß√£o
SELECT r.nome_regiao, r.abrangencia
FROM t_regionalizacao_regiao rr
JOIN t_regiao r ON rr.id_regiao = r.id_regiao
WHERE rr.id_tipo_regionalizacao = 'TRG01';

-- Temas por tipo
SELECT t.nome_tema, t.codigo_tema
FROM t_tipo_tema_tema ttt
JOIN t_tema t ON ttt.id_tema = t.id_tema
WHERE ttt.id_tipo_tema = 'TTM01';
```

### Verificar Attachments
```sql
-- Listar PDFs de uma publica√ß√£o
SELECT 
    attachmentid,
    att_name,
    data_size / 1024 / 1024 as size_mb,
    content_type
FROM t_publicacao__attach
WHERE rel_globalid = 'uuid-aqui'::uuid;
```

## üìö Refer√™ncias
- ESRI Attachments: https://developers.arcgis.com/rest/services-reference/attachment.htm
- Experience Builder: https://developers.arcgis.com/experience-builder/
- Feature Services: https://developers.arcgis.com/rest/services-reference/
- PostgreSQL UUID: https://www.postgresql.org/docs/current/datatype-uuid.html

## ‚ö†Ô∏è Avisos Cr√≠ticos

1. **NUNCA** modificar estrutura de tabelas sem documentar
2. **SEMPRE** validar FKs antes de inserir dados
3. **SEMPRE** usar globalid (UUID) para relacionar attachments
4. **SEMPRE** testar compatibilidade com apps existentes
5. **NUNCA** armazenar PDFs fora do PostgreSQL
6. **SEMPRE** validar combina√ß√µes via tabelas N:N
7. **NUNCA** assumir valores padr√£o sem consultar dom√≠nios

---

**Vers√£o**: 1.0  
**Data**: 2025-11-17  
**Projeto**: Mapoteca Digital  
**Organiza√ß√£o**: SEIGEO/SEI-BA  
**Database**: mapoteca  
**Schema**: dados_mapoteca